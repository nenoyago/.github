name: ‚úèÔ∏è PR Title Validator

on:
  workflow_call:

jobs:
  title-check:
    name: üîç Check PR Title Format
    runs-on: ubuntu-latest
    steps:
      - name: üìù Extract and validate title
        id: validate
        env:
          TITLE: ${{ github.event.pull_request.title }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
          # Regex: LIV- followed by one or more digits, space, hyphen, space, and at least one non-space character in the title.
          PATTERN: '^LIV-[0-9]+ - .*\S.*$'
        run: |
          echo "PR title: '$TITLE'"
          echo "Base branch: '$BASE_BRANCH'"
          echo "Head branch: '$HEAD_BRANCH'"

          # For PRs to 'stage', always validate
          if [ "$BASE_BRANCH" = "stage" ]; then
            echo "Validating title for PR to stage..."
          elif [ "$BASE_BRANCH" = "main" ]; then
            # For PRs to 'main', validate only if not from 'stage'
            if [ "$HEAD_BRANCH" = "stage" ]; then
              echo "PR from stage to main, skipping title validation."
              exit 0
            fi
            echo "Validating title for PR to main from non-stage branch..."
          else
            echo "Base branch not stage or main, skipping validation."
            exit 0
          fi

          if [ -z "$TITLE" ]; then
            echo "::error title=PR title validation::‚ùå PR title is empty."
            echo "Required format: LIV-{number} - description (e.g., LIV-123 - Task description)"
            exit 1
          fi

          if ! echo "$TITLE" | grep -E "$PATTERN" >/dev/null; then
            echo "::error title=PR title validation::‚ùå Invalid title. Must follow the pattern: LIV-{number} - description"
            echo "Example: LIV-123 - Fix bug in checkout flow"
            echo "Required regex: $PATTERN"
            exit 1
          fi

          echo "‚úÖ PR title is valid."

      - name: üîé Find existing bot comment
        if: always()
        uses: actions/github-script@v8
        id: find_comment
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment => 
              comment.body.includes('## ‚ùå Falha na Valida√ß√£o do T√≠tulo da PR') ||
              comment.body.includes('## ‚úÖ T√≠tulo da PR Validado com Sucesso')
            );

            return botComment ? botComment.id : null;

      - name: üíö Post success comment
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const commentBody = `## ‚úÖ T√≠tulo da PR Validado com Sucesso

            Perfeito! O t√≠tulo desta PR segue o padr√£o esperado. ‚ú®

            ### üìã Formato Validado:
            - **T√≠tulo atual:** \`${{ github.event.pull_request.title }}\`
            - **Padr√£o:** \`LIV-{n√∫mero} - descri√ß√£o\`
            - **Exemplo:** \`LIV-123 - Corrigir bug no checkout\`

            ### üéØ Status da Valida√ß√£o:
            - ‚úÖ Formato correto
            - ‚úÖ N√∫mero do ticket presente
            - ‚úÖ Descri√ß√£o significativa

            ---
            *ü§ñ √öltima verifica√ß√£o: ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}*`;

            const commentId = ${{ steps.find_comment.outputs.result }};

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      - name: üö® Post error comment
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const commentBody = `## ‚ùå Falha na Valida√ß√£o do T√≠tulo da PR

            O t√≠tulo desta PR n√£o segue o padr√£o esperado. Por favor, ajuste-o para continuar.

            ### üìã Formato Necess√°rio:
            **Padr√£o obrigat√≥rio:** \`LIV-{n√∫mero} - descri√ß√£o\`

            ### ‚úÖ Exemplos V√°lidos:
            - \`LIV-123 - Corrigir bug no checkout\`
            - \`LIV-456 - Adicionar nova funcionalidade de login\`
            - \`LIV-789 - Refatorar componente de usu√°rio\`

            ### ‚ùå Exemplos Inv√°lidos:
            - \`Corrigir bug\` (falta LIV- e n√∫mero)
            - \`LIV-123\` (falta descri√ß√£o)
            - \`LIV-abc - Descri√ß√£o\` (n√∫mero deve ser d√≠gitos)

            ### üîß Como Corrigir:
            1. Edite o t√≠tulo da PR
            2. Use o formato: \`LIV-{n√∫mero} - descri√ß√£o clara\`
            3. O workflow ser√° executado automaticamente

            ### üìö Regras Detalhadas:
            - Deve come√ßar com \`LIV-\`
            - Seguido de um ou mais d√≠gitos (ex: 123, 4567)
            - Espa√ßo, h√≠fen, espa√ßo
            - Descri√ß√£o significativa (n√£o vazia)

            ---
            *ü§ñ √öltima verifica√ß√£o: ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}*`;

            const commentId = ${{ steps.find_comment.outputs.result }};

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }
