name: ✏️ Validate PR Title Automation

on:
  workflow_call:

jobs:
  pr-title:
    name: Validate PR Title ✏️
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title
        id: validate
        env:
          TITLE: ${{ github.event.pull_request.title }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
          # Regex: LIV- followed by one or more digits, space, hyphen, space, and at least one non-space character in the title.
          PATTERN: '^LIV-[0-9]+ - .*\S.*$'
        run: |
          echo "PR title: '$TITLE'"
          echo "Base branch: '$BASE_BRANCH'"
          echo "Head branch: '$HEAD_BRANCH'"

          # For PRs to 'stage', always validate
          if [ "$BASE_BRANCH" = "stage" ]; then
            echo "Validating title for PR to stage..."
          elif [ "$BASE_BRANCH" = "main" ]; then
            # For PRs to 'main', validate only if not from 'stage'
            if [ "$HEAD_BRANCH" = "stage" ]; then
              echo "PR from stage to main, skipping title validation."
              exit 0
            fi
            echo "Validating title for PR to main from non-stage branch..."
          else
            echo "Base branch not stage or main, skipping validation."
            exit 0
          fi

          if [ -z "$TITLE" ]; then
            echo "::error title=PR title validation::❌ PR title is empty."
            echo "Required format: LIV-{number} - description (e.g., LIV-123 - Task description)"
            exit 1
          fi

          if ! echo "$TITLE" | grep -E "$PATTERN" >/dev/null; then
            echo "::error title=PR title validation::❌ Invalid title. Must follow the pattern: LIV-{number} - description"
            echo "Example: LIV-123 - Fix bug in checkout flow"
            echo "Required regex: $PATTERN"
            exit 1
          fi

          echo "✅ PR title is valid."

      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ PR title validated successfully!'
            })

      - name: Post error comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ PR title validation failed. Please ensure the title follows the format: LIV-{number} - description (e.g., LIV-123 - Fix bug).'
            })
